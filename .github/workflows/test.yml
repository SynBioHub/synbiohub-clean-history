name: Run release 

on: push

jobs:
  build: 
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: |
        docker build . --file docker/Dockerfile --tag synbiohub/synbiohub:snapshot-standalone
    - name: Package image
      run: |
        docker save synbiohub/synbiohub:snapshot-standalone | gzip > sbh.tar.gz
    - uses: actions/upload-artifact@v2
      with:
        name: sbh-image
        path: sbh.tar.gz
  sboltests:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v2
      with:
        name: sbh-image
    - name: Import saved Docker image
      run: |
        cat sbh.tar.gz | docker import - synbiohub/synbiohub:snapshot-standalone
    - name: Install test dependencies
      run: |
        pip install -r tests/test_requirements.txt
    - name: Run tests
      run: |
        tests/sbolsuite.sh
  sbhtests:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v2
      with:
        name: sbh-image
    - name: Import saved Docker image
      run: |
        cat sbh.tar.gz | docker import - synbiohub/synbiohub:snapshot-standalone
    - name: Install test dependencies
      run: |
        pip install -r tests/test_requirements.txt
    - name: Run tests
      run: |
        tests/test.sh --stopaftertestsuite
  publish:
    needs: [sboltests, sbhtests]
    runs-on: ubuntu-latest
    if: endsWith(github.ref, "master")
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v2
      with:
        name: sbh-image
    - name: Import saved Docker image
      run: |
        cat sbh.tar.gz | docker import - synbiohub/synbiohub:snapshot-standalone
    - uses: azure/docker-login@v1
      with: 
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Push the image to Docker Hub
      run: |
        docker push synbiohub/synbiohub:snapshot-standalone

